import { describe, expect, it } from "vitest";
import * as Builder from "../builder.js";
import * as Schema from "../schema.js";
import { createSyncCapability } from "./sync.js";

describe("Worker.sync", () => {
	describe("Schema.relation", () => {
		it("creates a relation property configuration", () => {
			const relationProp = Schema.relation("projectsSync");

			expect(relationProp).toEqual({
				type: "relation",
				relatedSyncKey: "projectsSync",
				config: { twoWay: false },
			});
		});

		it("can be used in a schema definition", () => {
			const capability = createSyncCapability("tasksSync", {
				primaryKeyProperty: "Task ID",
				schema: {
					defaultName: "Tasks",
					properties: {
						"Task ID": Schema.title(),
						Project: Schema.relation("projectsSync"),
					},
				},
				execute: async () => ({
					changes: [],
					hasMore: false,
				}),
			});

			expect(capability.config.schema.properties.Project).toEqual({
				type: "relation",
				relatedSyncKey: "projectsSync",
				config: { twoWay: false },
			});
		});
	});

	describe("Builder.relation", () => {
		it("creates a relation reference from a primary key", () => {
			const value = Builder.relation("project-123");

			expect(value).toEqual({ type: "primaryKey", value: "project-123" });
		});

		it("can be used to build relation arrays", () => {
			const value = [
				Builder.relation("project-123"),
				Builder.relation("project-456"),
			];

			expect(value).toEqual([
				{ type: "primaryKey", value: "project-123" },
				{ type: "primaryKey", value: "project-456" },
			]);
		});
	});

	describe("SyncedObject with relation properties", () => {
		it("allows relation values in synced objects", async () => {
			const capability = createSyncCapability("tasksSync", {
				primaryKeyProperty: "Task ID",
				schema: {
					defaultName: "Tasks",
					properties: {
						"Task ID": Schema.title(),
						Project: Schema.relation("projectsSync"),
					},
				},
				execute: async () => ({
					changes: [
						{
							type: "upsert",
							key: "task-1",
							properties: {
								"Task ID": Builder.title("TASK-001"),
								Project: [Builder.relation("project-123")],
							},
						},
						{
							type: "upsert",
							key: "task-2",
							properties: {
								"Task ID": Builder.title("TASK-002"),
								Project: [
									Builder.relation("project-123"),
									Builder.relation("project-456"),
								],
							},
						},
					],
					hasMore: false,
				}),
			});

			// Verify the capability is properly configured
			expect(capability._tag).toBe("sync");
			expect(capability.config.primaryKeyProperty).toBe("Task ID");
		});
	});
});
