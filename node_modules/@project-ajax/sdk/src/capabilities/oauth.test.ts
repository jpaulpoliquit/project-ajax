import { afterEach, describe, expect, it } from "vitest";
import { createOAuthCapability } from "./oauth.js";

describe("oauth", () => {
	afterEach(() => {
		// Clean up env changes between tests
		delete process.env.OAUTH_676F6F676C6541757468_ACCESS_TOKEN;
		delete process.env.OAUTH_676F6F676C652D63616C656E646172_ACCESS_TOKEN;
	});

	it("creates notion-managed oauth capability with accessToken helper", async () => {
		const capability = createOAuthCapability("googleAuth", {
			name: "googleAuth",
			provider: "google",
			accessTokenExpireMs: 60_000,
		});

		expect(capability).toBeDefined();
		expect(capability?._tag).toBe("oauth");
		expect(capability.config.type).toBe("notion_managed");
		expect(capability.config.accessTokenExpireMs).toBe(60_000);

		expect(typeof capability.accessToken).toBe("function");

		process.env.OAUTH_676F6F676C6541757468_ACCESS_TOKEN = "token-123";
		await expect(capability.accessToken()).resolves.toBe("token-123");
	});

	it("normalizes non-alphanumeric characters in the identifier", () => {
		const capability = createOAuthCapability("googleCalendar", {
			name: "google-calendar",
			provider: "google",
			accessTokenExpireMs: 3600_000,
		});

		expect(capability).toBeDefined();
		expect(capability?._tag).toBe("oauth");
		expect(capability.config.type).toBe("notion_managed");
		expect(capability.config.accessTokenExpireMs).toBe(3600_000);
	});

	it("throws a helpful error when the token env var is missing", async () => {
		const capability = createOAuthCapability("googleAuthMissing", {
			name: "googleAuth",
			provider: "google",
		});

		await expect(capability.accessToken()).rejects.toThrow(
			/Missing OAuth access token env var "OAUTH_676F6F676C6541757468_ACCESS_TOKEN"/,
		);
	});
});
