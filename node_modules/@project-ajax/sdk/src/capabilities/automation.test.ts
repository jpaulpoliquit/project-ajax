import {
	afterEach,
	beforeEach,
	describe,
	expect,
	it,
	type Mock,
	vi,
} from "vitest";
import { ExecutionError } from "../error.js";
import type { PageObjectResponse } from "./automation.js";
import { createAutomationCapability } from "./automation.js";

describe("createAutomationCapability", () => {
	let stdoutSpy: Mock<typeof process.stdout.write>;

	beforeEach(() => {
		stdoutSpy = vi
			.spyOn(process.stdout, "write")
			.mockImplementation(() => true);
	});

	afterEach(() => {
		vi.restoreAllMocks();
	});

	it("creates automation capability with correct structure", () => {
		const capability = createAutomationCapability("testAutomation", {
			title: "Test Automation",
			description: "Test automation description",
			execute: () => {},
		});

		expect(capability).toBeDefined();
		expect(capability?._tag).toBe("automation");
		expect(capability.config.title).toBe("Test Automation");
		expect(capability.config.description).toBe("Test automation description");
	});

	it("executes automation without page data", async () => {
		const executeFn = vi.fn();
		const capability = createAutomationCapability("syncAutomation", {
			title: "Sync Automation",
			description: "Executes synchronously",
			execute: executeFn,
		});

		const event = {
			pageId: "page-123",
			actionType: "test_action",
		};

		await capability.handler(event);

		expect(executeFn).toHaveBeenCalledWith(
			event,
			expect.objectContaining({
				notion: expect.any(Object),
			}),
		);
		expect(stdoutSpy).toHaveBeenCalledWith(
			`\n<output>{"status":"success"}</output>\n`,
		);
	});

	it("executes automation with page data", async () => {
		const executeFn = vi.fn();
		const capability = createAutomationCapability("pageAutomation", {
			title: "Page Automation",
			description: "Processes page data",
			execute: executeFn,
		});

		const pageData: PageObjectResponse = {
			object: "page",
			id: "page-789",
			created_time: "2023-01-01T00:00:00.000Z",
			last_edited_time: "2023-01-02T00:00:00.000Z",
			created_by: { id: "user-1" },
			last_edited_by: { id: "user-2" },
			cover: null,
			icon: null,
			parent: { type: "database_id", database_id: "db-123" },
			archived: false,
			properties: {
				Name: { id: "title", type: "title", title: [] },
				Status: { id: "status", type: "status", status: { name: "Done" } },
			},
			url: "https://notion.so/page-789",
			public_url: null,
		};

		const event = {
			pageId: "page-789",
			actionType: "process_page",
			pageData,
		};

		await capability.handler(event);

		expect(executeFn).toHaveBeenCalledWith(
			event,
			expect.objectContaining({
				notion: expect.any(Object),
			}),
		);
		expect(stdoutSpy).toHaveBeenCalledWith(
			`\n<output>{"status":"success"}</output>\n`,
		);
	});

	it("handles execution error from function", async () => {
		const capability = createAutomationCapability("errorAutomation", {
			title: "Error Automation",
			description: "Throws an error",
			execute: () => {
				throw new Error("Something went wrong");
			},
		});

		const event = {
			pageId: "page-error",
			actionType: "error_action",
		};

		await expect(capability.handler(event)).rejects.toThrow(ExecutionError);

		expect(stdoutSpy).toHaveBeenCalledWith(
			`\n<output>{"status":"error","error":{"name":"ExecutionError","message":"Error during worker execution: Error: Something went wrong"}}</output>\n`,
		);
	});

	it("handles execution error with non-Error object", async () => {
		const capability = createAutomationCapability("nonErrorAutomation", {
			title: "Non-Error Automation",
			description: "Throws a non-Error object",
			execute: () => {
				throw "String error";
			},
		});

		const event = {
			actionType: "string_error_action",
		};

		await expect(capability.handler(event)).rejects.toThrow(ExecutionError);

		expect(stdoutSpy).toHaveBeenCalledWith(
			`\n<output>{"status":"error","error":{"name":"ExecutionError","message":"Error during worker execution: String error"}}</output>\n`,
		);
	});
});
